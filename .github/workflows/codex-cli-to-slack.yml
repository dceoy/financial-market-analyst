---
name: Codex CLI with Slack notification
on:
  workflow_dispatch:
    inputs:
      codex-prompt:
        required: false
        type: string
        description: String passed to the Codex CLI as the primary prompt
        default: $market-brief
      codex-home:
        required: false
        type: string
        description: Path to the Codex CLI home directory
        default: .codex
      validate-codex-run-outcome:
        required: false
        type: boolean
        description: Whether to validate the outcome of the Codex CLI run
        default: true
      slack-message-text-file-path:
        required: false
        type: string
        description: Path to a file containing the text of the Slack message
        default: null
  workflow_call:
    inputs:
      codex-prompt:
        required: false
        type: string
        description: String passed to the Codex CLI as the primary prompt
        default: $market-brief
      codex-home:
        required: false
        type: string
        description: Path to the Codex CLI home directory
        default: .codex
      validate-codex-run-outcome:
        required: false
        type: boolean
        description: Whether to validate the outcome of the Codex CLI run
        default: true
      slack-message-text-file-path:
        required: false
        type: string
        description: Path to a file containing the text of the Slack message
        default: null
    secrets:
      OPENAI_API_KEY:
        required: true
        description: OpenAI API key used by the Codex CLI step
      SLACK_API_TOKEN:
        required: true
        description: Slack API token
      SLACK_CHANNEL_ID:
        required: true
        description: Slack channel ID for the Slack message
defaults:
  run:
    shell: bash -euo pipefail {0}
    working-directory: .
jobs:
  codex-to-slack:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Validate the Slack channel ID and API token
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}
        run: |
          if [[ -z "${OPENAI_API_KEY}" ]]; then
            echo "Error: OPENAI_API_KEY is not set." >&2
            exit 1
          elif [[ -z "${SLACK_CHANNEL_ID}" ]]; then
            echo "Error: SLACK_CHANNEL_ID is not set." >&2
            exit 2
          elif [[ -z "${SLACK_API_TOKEN}" ]]; then
            echo "Error: SLACK_API_TOKEN is not set." >&2
            exit 3
          fi
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Run Codex with the provided prompt
        id: codex-run
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189  # v1
        with:
          prompt: ${{ inputs.codex-prompt }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
        env:
          CODEX_HOME: ${{ inputs.codex-home }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      - name: Validate Codex run outcome
        if: >
          inputs.validate-codex-run-outcome && steps.codex-run.outcome != 'success'
        run: |
          echo "Error: Failed to create Slack message payload." >&2
          exit 1
      - name: Create a Slack message payload JSON from the Codex CLI results
        id: create-slack-payload
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.codex-run.outputs['final-message'] }}
          SLACK_MESSAGE_TEXT_FILE_PATH: ${{ inputs.slack-message-text-file-path }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          {
            if [[ -n "${SLACK_MESSAGE_TEXT_FILE_PATH}" ]]; then
              cat "${SLACK_MESSAGE_TEXT_FILE_PATH}"
            elif [[ -n "${CODEX_FINAL_MESSAGE}" ]]; then
              echo "${CODEX_FINAL_MESSAGE}"
            else
              echo
            fi
          } \
            | jq -crRs --arg channel "${SLACK_CHANNEL_ID}" '{channel:$channel, text:.} | "slack_payload_json=\(.)"' \
            | tee -a "${GITHUB_OUTPUT}"
      - name: Validate the Slack message payload
        if: >
          inputs.validate-codex-run-outcome
          && fromJson(steps.create-slack-payload.outputs.slack_payload_json).text == ''
        run: |
          echo "Error: Slack message payload is empty." >&2
          exit 1
      - name: Send the Slack message
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a  # v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_API_TOKEN }}
          payload: ${{ steps.create-slack-payload.outputs.slack_payload_json }}
